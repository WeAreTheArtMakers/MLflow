name: Promote Model And Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "GitHub environment"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: "Container image tag to deploy (example: sha-abcdef0)"
        required: true
        type: string
      namespace:
        description: "Kubernetes namespace"
        required: true
        default: "artpulse"
        type: string
      deployment:
        description: "Kubernetes deployment name"
        required: true
        default: "artpulse"
        type: string
      promote_alias:
        description: "Promote Model Registry alias before deployment"
        required: true
        default: true
        type: boolean
      source_alias:
        description: "Source alias"
        required: true
        default: "challenger"
        type: string
      target_alias:
        description: "Target alias"
        required: true
        default: "champion"
        type: string

permissions:
  contents: read

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  promote-model:
    if: ${{ inputs.promote_alias }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - name: Validate MLflow secrets
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_REGISTRY_URI: ${{ secrets.MLFLOW_REGISTRY_URI }}
        run: |
          set -euo pipefail
          test -n "$MLFLOW_TRACKING_URI"
          test -n "$MLFLOW_REGISTRY_URI"
      - name: Promote model alias
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_REGISTRY_URI: ${{ secrets.MLFLOW_REGISTRY_URI }}
          MODEL_NAME: ${{ vars.MODEL_NAME || 'artpulse-classifier' }}
        run: |
          set -euo pipefail
          python3 -m src.model_registry \
            --tracking-uri "$MLFLOW_TRACKING_URI" \
            --registry-uri "$MLFLOW_REGISTRY_URI" \
            promote-alias \
            --model-name "$MODEL_NAME" \
            --source-alias "${{ inputs.source_alias }}" \
            --target-alias "${{ inputs.target_alias }}"

  deploy:
    needs: [promote-model]
    if: ${{ always() && (needs.promote-model.result == 'success' || needs.promote-model.result == 'skipped') }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
    steps:
      - name: Validate deployment inputs
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
          K8S_NAMESPACE: ${{ inputs.namespace }}
          K8S_DEPLOYMENT: ${{ inputs.deployment }}
        run: |
          set -euo pipefail
          [[ "$IMAGE_TAG" =~ ^[A-Za-z0-9._-]+$ ]]
          [[ "$K8S_NAMESPACE" =~ ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]]
          [[ "$K8S_DEPLOYMENT" =~ ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$ ]]

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG }}
        run: |
          set -euo pipefail
          test -n "$KUBE_CONFIG_B64"
          umask 077
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_B64" | base64 -d > "$HOME/.kube/config"

      - name: Deploy image
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
          K8S_NAMESPACE: ${{ inputs.namespace }}
          K8S_DEPLOYMENT: ${{ inputs.deployment }}
        run: |
          set -euo pipefail
          IMAGE="ghcr.io/${{ github.repository_owner }}/artpulse:${IMAGE_TAG}"
          kubectl -n "$K8S_NAMESPACE" set image deployment/"$K8S_DEPLOYMENT" api="$IMAGE"
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/"$K8S_DEPLOYMENT" --timeout=180s
